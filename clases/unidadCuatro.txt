# ðŸ” UNIDAD 4 â€“ FILTROS Y BÃšSQUEDAS AVANZADAS

## 4.1 OPERADORES Y CONDICIONES

### 4a. Comparadores: =, >, <, !=

**Los comparadores bÃ¡sicos pero esenciales:**

```sql
-- Igualdad
SELECT * FROM productos WHERE precio = 99.99;

-- Mayor que
SELECT * FROM empleados WHERE salario > 50000;

-- Menor que
SELECT * FROM estudiantes WHERE edad < 25;

-- Mayor o igual que
SELECT * FROM pedidos WHERE total >= 1000;

-- Menor o igual que
SELECT * FROM productos WHERE stock <= 10;

-- Diferente de (!= o <>)
SELECT * FROM clientes WHERE ciudad != 'Madrid';
SELECT * FROM clientes WHERE ciudad <> 'Barcelona';
```

**Ejemplos prÃ¡cticos:**
```sql
-- Productos entre 50 y 100 euros
SELECT nombre, precio 
FROM productos 
WHERE precio >= 50 AND precio <= 100;

-- Empleados que no son del departamento de Ventas
SELECT nombre, departamento 
FROM empleados 
WHERE departamento != 'Ventas';

-- Clientes menores de 30 aÃ±os
SELECT nombre, edad 
FROM clientes 
WHERE edad < 30;
```

### 4b. LÃ³gicos: AND, OR, NOT

**Combinando condiciones para consultas mÃ¡s precisas:**

```sql
-- AND (todas las condiciones deben ser verdaderas)
SELECT * FROM productos 
WHERE precio > 50 AND stock > 0;

-- OR (al menos una condiciÃ³n debe ser verdadera)
SELECT * FROM clientes 
WHERE ciudad = 'Madrid' OR ciudad = 'Barcelona';

-- NOT (niega la condiciÃ³n)
SELECT * FROM empleados 
WHERE NOT departamento = 'IT';

-- Combinaciones complejas
SELECT * FROM pedidos 
WHERE (total > 1000 OR cliente_id = 5) 
AND fecha >= '2024-01-01';
```

**Ejemplos con parÃ©ntesis para agrupar condiciones:**
```sql
-- Clientes de Madrid o Barcelona mayores de 25 aÃ±os
SELECT * FROM clientes 
WHERE (ciudad = 'Madrid' OR ciudad = 'Barcelona') 
AND edad > 25;

-- Productos electrÃ³nicos con precio alto o stock bajo
SELECT * FROM productos 
WHERE categoria = 'ElectrÃ³nicos' 
AND (precio > 500 OR stock < 5);
```

### 4c. BETWEEN, IN, LIKE, IS NULL

**BETWEEN - Para rangos de valores:**
```sql
-- Entre dos valores (inclusive)
SELECT * FROM productos WHERE precio BETWEEN 50 AND 100;

-- Equivale a:
SELECT * FROM productos WHERE precio >= 50 AND precio <= 100;

-- Fechas en un rango
SELECT * FROM pedidos 
WHERE fecha BETWEEN '2024-01-01' AND '2024-01-31';
```

**IN - Para mÃºltiples valores especÃ­ficos:**
```sql
-- Ciudades especÃ­ficas
SELECT * FROM clientes 
WHERE ciudad IN ('Madrid', 'Barcelona', 'Valencia');

-- Equivale a:
SELECT * FROM clientes 
WHERE ciudad = 'Madrid' OR ciudad = 'Barcelona' OR ciudad = 'Valencia';

-- IDs especÃ­ficos
SELECT * FROM productos 
WHERE id IN (1, 5, 8, 12);
```

**LIKE - Para bÃºsquedas de texto con patrones:**
```sql
-- % representa cualquier cantidad de caracteres
-- _ representa un solo carÃ¡cter

-- Empieza con 'A'
SELECT * FROM clientes WHERE nombre LIKE 'A%';

-- Termina con 'ez'
SELECT * FROM clientes WHERE nombre LIKE '%ez';

-- Contiene 'mar'
SELECT * FROM productos WHERE nombre LIKE '%mar%';

-- Exactamente 5 caracteres que empiezan con 'A'
SELECT * FROM clientes WHERE nombre LIKE 'A____';

-- Segunda letra es 'a'
SELECT * FROM clientes WHERE nombre LIKE '_a%';
```

**IS NULL - Para valores nulos:**
```sql
-- Clientes sin telÃ©fono
SELECT * FROM clientes WHERE telefono IS NULL;

-- Productos sin descripciÃ³n
SELECT * FROM productos WHERE descripcion IS NOT NULL;

-- Pedidos sin fecha de entrega
SELECT * FROM pedidos WHERE fecha_entrega IS NULL;
```

## 4.2 FUNCIONES ÃšTILES EN CONSULTAS

### 4a. COUNT(), MAX(), MIN(), SUM(), AVG()

**Funciones de agregaciÃ³n para anÃ¡lisis de datos:**

```sql
-- COUNT() - Contar registros
SELECT COUNT(*) AS total_clientes FROM clientes;
SELECT COUNT(*) AS clientes_madrid FROM clientes WHERE ciudad = 'Madrid';

-- MAX() - Valor mÃ¡ximo
SELECT MAX(precio) AS precio_maximo FROM productos;
SELECT MAX(fecha_nacimiento) FROM empleados; -- Persona mÃ¡s joven

-- MIN() - Valor mÃ­nimo
SELECT MIN(precio) AS precio_minimo FROM productos;
SELECT MIN(fecha_contratacion) FROM empleados; -- Empleado mÃ¡s antiguo

-- SUM() - Suma de valores
SELECT SUM(total) AS ventas_totales FROM pedidos;
SELECT SUM(stock) AS inventario_total FROM productos;

-- AVG() - Promedio de valores
SELECT AVG(precio) AS precio_promedio FROM productos;
SELECT AVG(edad) AS edad_promedia FROM clientes;
```

**Ejemplos combinados:**
```sql
-- EstadÃ­sticas completas de productos
SELECT 
    COUNT(*) AS total_productos,
    MIN(precio) AS precio_minimo,
    MAX(precio) AS precio_maximo,
    AVG(precio) AS precio_promedio,
    SUM(stock) AS inventario_total
FROM productos;
```

### 4b. Agrupar con GROUP BY

**Agrupar resultados por categorÃ­as:**

```sql
-- Ventas totales por cliente
SELECT cliente_id, SUM(total) AS total_compras
FROM pedidos
GROUP BY cliente_id;

-- Cantidad de productos por categorÃ­a
SELECT categoria, COUNT(*) AS cantidad_productos
FROM productos
GROUP BY categoria;

-- Promedio de salario por departamento
SELECT departamento, AVG(salario) AS salario_promedio
FROM empleados
GROUP BY departamento;

-- MÃºltiples agrupaciones
SELECT departamento, cargo, AVG(salario) AS salario_promedio
FROM empleados
GROUP BY departamento, cargo;
```

**Ejemplos prÃ¡cticos:**
```sql
-- Productos por categorÃ­a con estadÃ­sticas
SELECT 
    categoria,
    COUNT(*) AS cantidad,
    MIN(precio) AS precio_min,
    MAX(precio) AS precio_max,
    AVG(precio) AS precio_promedio
FROM productos
GROUP BY categoria
ORDER BY cantidad DESC;

-- Ventas mensuales
SELECT 
    YEAR(fecha) AS aÃ±o,
    MONTH(fecha) AS mes,
    COUNT(*) AS total_pedidos,
    SUM(total) AS ventas_totales
FROM pedidos
GROUP BY YEAR(fecha), MONTH(fecha)
ORDER BY aÃ±o, mes;
```

### 4c. Filtrar grupos con HAVING

**HAVING vs WHERE:**
- **WHERE** filtra registros antes de agrupar
- **HAVING** filtra grupos despuÃ©s de agrupar

```sql
-- CategorÃ­as con mÃ¡s de 5 productos
SELECT categoria, COUNT(*) AS cantidad
FROM productos
GROUP BY categoria
HAVING COUNT(*) > 5;

-- Clientes que han gastado mÃ¡s de 1000â‚¬
SELECT cliente_id, SUM(total) AS total_gastado
FROM pedidos
GROUP BY cliente_id
HAVING SUM(total) > 1000;

-- Departamentos con salario promedio mayor a 40000
SELECT departamento, AVG(salario) AS salario_promedio
FROM empleados
GROUP BY departamento
HAVING AVG(salario) > 40000;
```

**Ejemplos combinando WHERE y HAVING:**
```sql
-- CategorÃ­as con promedio de precio > 50 (sÃ³lo productos activos)
SELECT categoria, AVG(precio) AS precio_promedio
FROM productos
WHERE activo = TRUE  -- Filtra antes de agrupar
GROUP BY categoria
HAVING AVG(precio) > 50;  -- Filtra despuÃ©s de agrupar

-- Ventas por cliente en 2024 (sÃ³lo clientes con mÃ¡s de 3 pedidos)
SELECT 
    cliente_id, 
    COUNT(*) AS total_pedidos,
    SUM(total) AS total_ventas
FROM pedidos
WHERE YEAR(fecha) = 2024  -- SÃ³lo pedidos de 2024
GROUP BY cliente_id
HAVING COUNT(*) > 3;  -- SÃ³lo clientes con mÃ¡s de 3 pedidos
```

## ðŸŽ¯ EJERCICIOS PRÃCTICOS COMPLETOS

### Ejercicio 1: AnÃ¡lisis de Ventas
```sql
-- Crear tabla de ventas
CREATE TABLE ventas (
    id INT PRIMARY KEY AUTO_INCREMENT,
    producto_id INT,
    cantidad INT,
    precio_unitario DECIMAL(10, 2),
    fecha DATE,
    vendedor_id INT
);

-- Insertar datos de ejemplo
INSERT INTO ventas (producto_id, cantidad, precio_unitario, fecha, vendedor_id) VALUES
(1, 2, 50.00, '2024-01-15', 101),
(2, 1, 120.00, '2024-01-15', 102),
(1, 3, 50.00, '2024-01-16', 101),
(3, 2, 75.00, '2024-01-16', 103),
(2, 1, 120.00, '2024-01-17', 102);

-- Consultas de anÃ¡lisis
-- 1. Ventas totales por dÃ­a
SELECT fecha, SUM(cantidad * precio_unitario) AS ventas_totales
FROM ventas
GROUP BY fecha
ORDER BY fecha;

-- 2. Mejor vendedor del mes
SELECT vendedor_id, SUM(cantidad * precio_unitario) AS total_ventas
FROM ventas
WHERE MONTH(fecha) = 1 AND YEAR(fecha) = 2024
GROUP BY vendedor_id
ORDER BY total_ventas DESC
LIMIT 1;

-- 3. Productos que han vendido mÃ¡s de 3 unidades
SELECT producto_id, SUM(cantidad) AS total_vendido
FROM ventas
GROUP BY producto_id
HAVING SUM(cantidad) > 3;
```

### Ejercicio 2: AnÃ¡lisis de Empleados
```sql
-- Consultas complejas
SELECT 
    departamento,
    COUNT(*) AS total_empleados,
    MIN(salario) AS salario_minimo,
    MAX(salario) AS salario_maximo,
    AVG(salario) AS salario_promedio,
    SUM(salario) AS masa_salarial
FROM empleados
WHERE activo = TRUE
GROUP BY departamento
HAVING AVG(salario) > 30000
ORDER BY salario_promedio DESC;
```

## ðŸ“Š RESUMEN VISUAL DE FUNCIONES

```
FUNCIONES DE AGREGACIÃ“N
â”‚
â”œâ”€â”€ COUNT() â†’ Conteo de registros
â”œâ”€â”€ SUM() â†’ Suma de valores
â”œâ”€â”€ AVG() â†’ Promedio de valores
â”œâ”€â”€ MAX() â†’ Valor mÃ¡ximo
â””â”€â”€ MIN() â†’ Valor mÃ­nimo

CLAÃšSULAS DE AGRUPAMIENTO
â”‚
â”œâ”€â”€ GROUP BY â†’ Agrupar por categorÃ­as
â””â”€â”€ HAVING â†’ Filtrar grupos (despuÃ©s de agrupar)

OPERADORES AVANZADOS
â”‚
â”œâ”€â”€ BETWEEN â†’ Rangos de valores
â”œâ”€â”€ IN â†’ MÃºltiples valores especÃ­ficos
â”œâ”€â”€ LIKE â†’ BÃºsquedas de texto con patrones
â””â”€â”€ IS NULL â†’ Valores nulos
```

## ðŸš€ PRÃ“XIMOS PASOS

Ahora tienes herramientas poderosas para anÃ¡lisis de datos. En la siguiente unidad aprenderemos:
- **JOINS** para combinar datos de mÃºltiples tablas
- **Subconsultas** avanzadas
- **Vistas** para simplificar consultas complejas
- **Funciones** personalizadas